name: Generate Release Notes

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆåœ¨æ¯å°æ—¶çš„ç¬¬ 0 åˆ†é’Ÿï¼‰
    - cron: '0 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'internal/release_notes/**'
      - 'web/templates/**'
      - '.github/workflows/release-notes.yml'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Build HTML generator
        run: |
          go build -o generate-html ./cmd/generate-html
          chmod +x generate-html

      - name: Generate HTML
        run: |
          ./generate-html
          
          if [ ! -f release-notes.html ]; then
            echo "âŒ Failed to generate HTML file"
            exit 1
          fi
          
          echo "âœ… HTML generated successfully!"

      - name: Prepare GitHub Pages content
        run: |
          mkdir -p gh-pages
          mv release-notes.html gh-pages/index.html
          
          # æ·»åŠ  CNAME æ–‡ä»¶ï¼ˆå¦‚æžœéœ€è¦è‡ªå®šä¹‰åŸŸåï¼‰
          # echo "your-domain.com" > gh-pages/CNAME
          
          # æ·»åŠ  .nojekyll æ–‡ä»¶ä»¥ç¦ç”¨ Jekyll å¤„ç†
          touch gh-pages/.nojekyll
          
          # æ·»åŠ æ›´æ–°æ—¶é—´ä¿¡æ¯
          echo "Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > gh-pages/last-update.txt
          
          echo "âœ… GitHub Pages content prepared!"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Update release notes - ${{ github.sha }}'

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release Notes Updated!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The release notes page has been successfully generated and deployed to GitHub Pages." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Last Updated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**View at:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
