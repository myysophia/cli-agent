name: Cursor Agent Test

on:
  schedule:
    # ÊØèÂ§© UTC Êó∂Èó¥ 8:00 ËøêË°åÔºàÂåó‰∫¨Êó∂Èó¥ 16:00Ôºâ
    - cron: '0 8 * * *'
  workflow_dispatch: # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë
    inputs:
      test_prompt:
        description: 'Ëá™ÂÆö‰πâÊµãËØïÊèêÁ§∫ÔºàÂèØÈÄâÔºâ'
        required: false
        default: ''
  push:
    branches:
      - main
    paths:
      - '.github/workflows/cursor-agent-test.yml'
      - '.cursor-agent/**'

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}

jobs:
  cursor-agent-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python (for MCP servers)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv (for MCP servers)
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Verify Cursor CLI installation
        run: |
          cursor-agent --version || echo "Version check not available"
          echo "‚úÖ Cursor CLI installed successfully"

      - name: Setup MCP configuration
        run: |
          mkdir -p .cursor
          cat > .cursor/mcp.json << 'EOF'
          {
            "mcpServers": {
              "filesystem": {
                "command": "uvx",
                "args": ["mcp-server-filesystem", "--allowed-directories", "."],
                "env": {}
              },
              "fetch": {
                "command": "uvx",
                "args": ["mcp-server-fetch"],
                "env": {}
              }
            }
          }
          EOF
          echo "‚úÖ MCP configuration created"
          cat .cursor/mcp.json

      - name: Test 1 - Code Analysis
        id: test1
        continue-on-error: true
        run: |
          echo "üß™ Test 1: Analyzing project structure..."
          cursor-agent -p "ÂàÜÊûêËøô‰∏™ Go È°πÁõÆÁöÑÁªìÊûÑÔºåÂàóÂá∫‰∏ªË¶ÅÁöÑÂåÖÂíåÂÆÉ‰ª¨ÁöÑÂäüËÉΩ„ÄÇËØ∑ÁÆÄÊ¥ÅÂõûÁ≠î„ÄÇ" \
            --model claude-sonnet-4-20250514 \
            --max-turns 3 \
            2>&1 | tee test1_output.txt
          echo "test1_status=$?" >> $GITHUB_OUTPUT

      - name: Test 2 - Release Notes Check
        id: test2
        continue-on-error: true
        run: |
          echo "üß™ Test 2: Checking release notes functionality..."
          cursor-agent -p "Ê£ÄÊü• internal/release_notes ÁõÆÂΩï‰∏ãÁöÑ‰ª£Á†ÅÔºåÂëäËØâÊàëÊîØÊåÅÂì™‰∫õ CLI Â∑•ÂÖ∑ÁöÑ release notes Ëé∑Âèñ„ÄÇ" \
            --model claude-sonnet-4-20250514 \
            --max-turns 3 \
            2>&1 | tee test2_output.txt
          echo "test2_status=$?" >> $GITHUB_OUTPUT

      - name: Test 3 - API Endpoint Review
        id: test3
        continue-on-error: true
        run: |
          echo "üß™ Test 3: Reviewing API endpoints..."
          cursor-agent -p "Êü•Áúã internal/handler ÁõÆÂΩïÔºåÂàóÂá∫ÊâÄÊúâ HTTP API Á´ØÁÇπÂèäÂÖ∂ÂäüËÉΩ„ÄÇ" \
            --model claude-sonnet-4-20250514 \
            --max-turns 3 \
            2>&1 | tee test3_output.txt
          echo "test3_status=$?" >> $GITHUB_OUTPUT

      - name: Test 4 - MCP Tool Usage (Fetch)
        id: test4
        continue-on-error: true
        run: |
          echo "üß™ Test 4: Testing MCP fetch tool..."
          cursor-agent -p "‰ΩøÁî® fetch Â∑•ÂÖ∑Ëé∑Âèñ https://api.github.com/repos/anthropics/claude-code/releases/latest ÁöÑÂÜÖÂÆπÔºåÂëäËØâÊàë Claude CLI ÁöÑÊúÄÊñ∞ÁâàÊú¨Âè∑„ÄÇ" \
            --model claude-sonnet-4-20250514 \
            --max-turns 5 \
            2>&1 | tee test4_output.txt
          echo "test4_status=$?" >> $GITHUB_OUTPUT

      - name: Test 5 - Custom Prompt (if provided)
        id: test5
        if: ${{ github.event.inputs.test_prompt != '' }}
        continue-on-error: true
        run: |
          echo "üß™ Test 5: Running custom prompt..."
          cursor-agent -p "${{ github.event.inputs.test_prompt }}" \
            --model claude-sonnet-4-20250514 \
            --max-turns 5 \
            2>&1 | tee test5_output.txt
          echo "test5_status=$?" >> $GITHUB_OUTPUT

      - name: Generate Test Report
        run: |
          echo "# ü§ñ Cursor Agent Test Report" > test_report.md
          echo "" >> test_report.md
          echo "**Run Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> test_report.md
          echo "**Triggered By:** ${{ github.event_name }}" >> test_report.md
          echo "**Commit:** ${{ github.sha }}" >> test_report.md
          echo "" >> test_report.md
          
          echo "## üìä Test Results Summary" >> test_report.md
          echo "" >> test_report.md
          echo "| Test | Description | Status |" >> test_report.md
          echo "|------|-------------|--------|" >> test_report.md
          
          # Test 1
          if [ -f test1_output.txt ]; then
            echo "| Test 1 | Code Analysis | ‚úÖ Completed |" >> test_report.md
          else
            echo "| Test 1 | Code Analysis | ‚ùå Failed |" >> test_report.md
          fi
          
          # Test 2
          if [ -f test2_output.txt ]; then
            echo "| Test 2 | Release Notes Check | ‚úÖ Completed |" >> test_report.md
          else
            echo "| Test 2 | Release Notes Check | ‚ùå Failed |" >> test_report.md
          fi
          
          # Test 3
          if [ -f test3_output.txt ]; then
            echo "| Test 3 | API Endpoint Review | ‚úÖ Completed |" >> test_report.md
          else
            echo "| Test 3 | API Endpoint Review | ‚ùå Failed |" >> test_report.md
          fi
          
          # Test 4
          if [ -f test4_output.txt ]; then
            echo "| Test 4 | MCP Fetch Tool | ‚úÖ Completed |" >> test_report.md
          else
            echo "| Test 4 | MCP Fetch Tool | ‚ùå Failed |" >> test_report.md
          fi
          
          # Test 5 (custom)
          if [ -f test5_output.txt ]; then
            echo "| Test 5 | Custom Prompt | ‚úÖ Completed |" >> test_report.md
          elif [ "${{ github.event.inputs.test_prompt }}" != "" ]; then
            echo "| Test 5 | Custom Prompt | ‚ùå Failed |" >> test_report.md
          fi
          
          echo "" >> test_report.md
          echo "## üìù Detailed Results" >> test_report.md
          echo "" >> test_report.md
          
          for i in 1 2 3 4 5; do
            if [ -f "test${i}_output.txt" ]; then
              echo "### Test $i Output" >> test_report.md
              echo '```' >> test_report.md
              head -100 "test${i}_output.txt" >> test_report.md
              echo '```' >> test_report.md
              echo "" >> test_report.md
            fi
          done
          
          echo "‚úÖ Test report generated"
          cat test_report.md

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        with:
          name: cursor-agent-test-report
          path: |
            test_report.md
            test*_output.txt
          retention-days: 30

      - name: Post Summary
        run: |
          cat test_report.md >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        run: |
          failed=0
          for i in 1 2 3 4; do
            if [ ! -f "test${i}_output.txt" ]; then
              failed=$((failed + 1))
            fi
          done
          
          if [ $failed -gt 2 ]; then
            echo "‚ùå Too many tests failed ($failed/4)"
            exit 1
          else
            echo "‚úÖ Tests completed with $failed failures"
          fi
